import sqlite3
import tkinter as tk
from tkinter import ttk
from tkinter import messagebox

import customtkinter 

# Cria√ß√£o do banco de dados:

def conectar():
    #Cria o banco de dados de leads
    return sqlite3.connect('leads.db')

def criar_tabela():
    #Cria√ß√£o da tabela de leads
    conn = conectar()
    c = conn.cursor()
    c.execute(''' CREATE TABLE IF NOT EXISTS leads (
                nome TEXT,
                email TEXT PRIMARY KEY, 
                telefone TEXT,
                interesse TEXT,
                status TEXT
                )''')
    conn.commit()
    conn.close()
    

def limpar_campos():
    #Fun√ß√£o para deletar os cadastros
    nome_entry.delete(0, tk.END)
    email_entry.delete(0, tk.END)
    telefone_entry.delete(0, tk.END)
    interesse_entry.delete(0, tk.END)
    status_combobox.set('Em Andamento') 

# Cria√ß√£o de leads
def inserir_lead():
    #Inserindo lead no sistema
    nome = nome_entry.get()
    email = email_entry.get()
    telefone = telefone_entry.get()
    interesse = interesse_entry.get()
    status = status_combobox.get()
    # C√≥digo da biblioteca que permite retornar o status do lead 

    if nome and email and telefone and interesse and status:
        conn = conectar()
        c = conn.cursor()
        try:
            c.execute("INSERT INTO leads VALUES(?,?,?,?,?)", (nome, email, telefone, interesse, status))
            conn.commit()
            messagebox.showinfo('Sucesso', 'Lead cadastrado com sucesso!') 
            limpar_campos()
            mostrar_leads()
        except sqlite3.IntegrityError:
            messagebox.showerror('Erro', 'Este E-mail j√° est√° cadastrado')
        finally:
            conn.close()
    else:
        messagebox.showwarning('Erro', 'Todos os campos devem ser preenchidos!')

# Read 
def mostrar_leads(): 
    # Aqui ser√£o exibidos os leads na treeview
    for row in tree.get_children():
        tree.delete(row)
            
    conn = conectar()
    c = conn.cursor()
    c.execute('SELECT * FROM leads')
    leads = c.fetchall()
   # Todos os dados ser√£o pegos e transmitidos √† treeview
    for lead in leads:
        tree.insert("", "end", values=lead)
    conn.close()    

def preencher_campos(event):
    limpar_campos()
    selecao = tree.selection()
    if selecao:
        dados = tree.item(selecao)['values']
        
        nome_entry.insert(0, dados[0])
        email_entry.insert(0, dados[1])
        telefone_entry.insert(0, dados[2])
        interesse_entry.insert(0, dados[3])
        status_combobox.set(dados[4])
        # Aqui est√° definido o valor que ser√° atribu√≠do ao combobox (widget de interface gr√°fica) 

# Atualiza√ß√£o de dados do lead selecionado
def atualizar_lead():
    selecao = tree.selection()
    if selecao:
        # Seleciona o email registrado para usar no WHERE
        email_original = tree.item(selecao)['values'][1]
        
        novo_nome = nome_entry.get()
        novo_email = email_entry.get()
        novo_telefone = telefone_entry.get()
        novo_interesse = interesse_entry.get()
        novo_status = status_combobox.get()

        if novo_nome and novo_email and novo_telefone and novo_interesse and novo_status:
            conn = conectar()
            c = conn.cursor()
            try:
                # O email original √© usado no WHERE para atualizar o registro
                c.execute("""
                    UPDATE leads 
                    SET nome = ?, email = ?, telefone = ?, interesse = ?, status = ?  
                    WHERE email = ? 
                """, (novo_nome, novo_email, novo_telefone, novo_interesse, novo_status, email_original))
                conn.commit()
                messagebox.showinfo('Lead atualizado com sucesso!') 
                limpar_campos()
                mostrar_leads()
            except sqlite3.IntegrityError:
                messagebox.showerror('Erro', 'O novo E-mail j√° est√° cadastrado para outro Lead')
            finally:
                conn.close()
        else:
            messagebox.showwarning('Aten√ß√£o', 'Todos os campos precisam ser preenchidos para a atualiza√ß√£o')
    else:
        messagebox.showerror('Erro', 'Selecione um Lead na tabela para atualizar')
        
# Delete
def deletar_lead():
    # Exclui os dados do lead selecionado
    selecao = tree.selection()
    if selecao:
        # Seleciona o email do lead e deleta
        email_del = tree.item(selecao)['values'][1]
        
        if messagebox.askyesno('Confirma√ß√£o', f 'Tem certeza que deseja deletar o lead com E-mail: {email_del}?'):
            conn = conectar()
            c = conn.cursor()        
            c.execute("DELETE FROM leads WHERE email = ?", (email_del,))
            conn.commit()
            conn.close()
            messagebox.showinfo('Lead deletado com sucesso!')
            limpar_campos()
            mostrar_leads()
    else:
        messagebox.showerror('Erro', 'Selecione um Lead na tabela para deletar')    

# Interface gr√°fica do TKinter

janela = tk.Tk()
janela.title('CRM de Leads - Yago Marketing Leads')
janela.geometry('900x650') 

caminho = 'p_ico.ico' 
janela.iconbitmap(caminho)

# T√≠tulo
tk.Label(janela, text='üìà Formul√°rio de cadastro de leads', font=('Arial', 18, 'bold')).grid(row=0, column=0, pady=10, padx=10, columnspan=2)

# Frame para inserir dados
fr0 = tk.Frame(janela)
fr0.grid(row=1, column=0, columnspan=2, pady=10)

# Nome
nome_label = tk.Label(fr0, text='Nome:', font=('Arial', 12))
nome_label.grid(row=1, column=0, pady=5, padx=5, sticky='w')
nome_entry = tk.Entry(fr0, font=('Arial', 12), width=35)
nome_entry.grid(row=1, column=1, pady=5, padx=5)

# E-mail (Chave √önica)
email_label = tk.Label(fr0, text='E-mail:', font=('Arial', 12))
email_label.grid(row=2, column=0, pady=5, padx=5, sticky='w')
email_entry = tk.Entry(fr0, font=('Arial', 12), width=35)
email_entry.grid(row=2, column=1, pady=5, padx=5)

# Telefone
telefone_label = tk.Label(fr0, text='Telefone:', font=('Arial', 12))
telefone_label.grid(row=3, column=0, pady=5, padx=5, sticky='w')
telefone_entry = tk.Entry(fr0, font=('Arial', 12), width=35)
telefone_entry.grid(row=3, column=1, pady=5, padx=5)

# Interesse do lead
interesse_label = tk.Label(fr0, text='Interesse do lead:', font=('Arial', 12))
interesse_label.grid(row=4, column=0, pady=5, padx=5, sticky='w')
interesse_entry = tk.Entry(fr0, font=('Arial', 12), width=35)
interesse_entry.grid(row=4, column=1, pady=5, padx=5)

# Status do Lead - O combobox est√° sendo usado
status_label = tk.Label(fr0, text='Status do Lead:', font=('Arial', 12))
status_label.grid(row=5, column=0, pady=5, padx=5, sticky='w')

status_opcoes = ['Em Andamento', 'Convertido', 'Perdido', 'Novo']
status_combobox = ttk.Combobox(fr0, values=status_opcoes, font=('Arial', 12), width=33, state='readonly')
status_combobox.set('Novo') 
status_combobox.grid(row=5, column=1, pady=5, padx=5)

# Frame para os bot√µes do CRUD
fr = tk.Frame(janela)
fr.grid(row=2, column=0, columnspan=2, pady=15)

# Bot√µes
btn_salvar = tk.Button(fr, text='‚ûï SALVAR NOVO', font=('Arial', 12, 'bold'), bg='#4CAF50', fg='white', command=inserir_lead)
btn_salvar.grid(row=0, column=0, padx=10, pady=5, ipadx=5)

btn_atualizar = tk.Button(fr, text='‚úèÔ∏è ATUALIZAR STATUS/DADOS', font=('Arial', 12, 'bold'), bg='#2196F3', fg='white', command=atualizar_lead)
btn_atualizar.grid(row=0, column=1, padx=10, pady=5, ipadx=5)

btn_delete = tk.Button(fr, text='üóëÔ∏è DELETAR LEAD', font=('Arial', 12, 'bold'), bg='#F44336', fg='white', command=deletar_lead)
btn_delete.grid(row=0, column=2, padx=10, pady=5, ipadx=5)

# Frame para a Treeview
fr2 = tk.Frame(janela)
fr2.grid(row=3, column=0, columnspan=2, padx=10, pady=10, sticky='nsew')

# Configura√ß√£o da Treeview
colunas = ('NOME', 'E-MAIL', 'TELEFONE', 'INTERESSE', 'STATUS')
tree = ttk.Treeview(fr2, columns=colunas, show='headings', height=15)
tree.grid(row=0, column=0, sticky='nsew')

# Configura√ß√£o das colunas e headings
for col in colunas:
    tree.heading(col, text=col, anchor=tk.CENTER)

# Definir largura das colunas
tree.column('NOME', width=150, anchor=tk.W)
tree.column('E-MAIL', width=200, anchor=tk.W)
tree.column('TELEFONE', width=100, anchor=tk.CENTER)
tree.column('INTERESSE', width=200, anchor=tk.W)
tree.column('STATUS', width=150, anchor=tk.CENTER)

# Adicionar Scrollbar
scrollbar = ttk.Scrollbar(fr2, orient=tk.VERTICAL, command=tree.yview)
tree.configure(yscrollcommand=scrollbar.set)
scrollbar.grid(row=0, column=1, sticky='ns')

# Vincula√ß√£o da sele√ß√£o da Treeview √† fun√ß√£o que preenche os campos
tree.bind('<<TreeviewSelect>>', preencher_campos)

# Inicializa√ß√£o
criar_tabela()
mostrar_leads()

janela.mainloop()
